<template>
	<scroll-view class="uni-container" v-if="!loading">
		<view class="uni-margin-wrap">
			<swiper class="swiper" circular :indicator-dots="indicatorDots" :autoplay="autoplay" :interval="interval"
				:duration="duration">
				<swiper-item>
					<view class="swiper-item uni-bg-red">
						<image class="banner-image" src="/static/banner.jpeg"></image>
					</view>
				</swiper-item>
				<swiper-item>
					<view class="swiper-item uni-bg-green">B</view>
				</swiper-item>
				<swiper-item>
					<view class="swiper-item uni-bg-blue">C</view>
				</swiper-item>
			</swiper>
		</view>
		<view class="container" scroll-y="true">
	<!-- 		<refresh @refresh="onrefresh" name="leaseFresh">
			</refresh> -->
			<uni-fab ref="fab" :pattern="pattern" :content="content" :horizontal="horizontal" :vertical="vertical"
				:direction="direction" @trigger="trigger" @fabClick="fabClick" />


			<view class="uni-panel" v-for="(item, index) in list" :key="index">
				<uni-card :title="item.goodsName" :isFull="true" :extra="String(index+1)" :thumbnail="item.iconUrl">
					<!-- 				<image class="uni-header-image" :src="item.iconUrl"></image> -->
					<uni-row class="demo-uni-row">
						<uni-col :span="8">
							<view class="example-body">

								<text class="AA-money">Â¥ {{item.price/100.0}} </text>
								<text class="rental-trend">ğŸ”¥ {{item.leaseCountChange7}} </text>
							</view>

						</uni-col>
						<uni-col :span="16" :offset="6">
							<view class="example-body">

								<uni-tooltip class="AA-money-change"
									:content="getChangeTips(item.minPriceChangePercent)"
									v-if="item.minPriceChangePercent[pricesChangeDay]>0">ä»·æ ¼å˜åŠ¨:
									ğŸ“ˆ{{(item.minPriceChangePercent[pricesChangeDay] *100).toFixed(3)}} %</uni-tooltip>
								<uni-tooltip class="AA-money-change-down"
									:content="getChangeTips(item.minPriceChangePercent)" v-else>ä»·æ ¼å˜åŠ¨:
									ğŸ“‰{{(item.minPriceChangePercent[pricesChangeDay] *100).toFixed(3)}} %
								</uni-tooltip>
							</view>
						</uni-col>



					</uni-row>
					<uni-row class="demo-uni-row">
						<uni-col :span="12">
							<view class="example-body">
								<text class="rental-prices">çŸ­ç§Ÿ: {{item.leasePrice/100.0}}
								</text>
								<text class="rental-prices">é•¿ç§Ÿ: {{item.longLeasePrice/100.0}}
								</text>
							</view>

						</uni-col>
						<uni-col :span="14" :offset="2">
							<view class="example-body">

								<text class="AA-time-return">{{countShortLease(item.leasePrice,item.price)}} %</text>
							</view>
						</uni-col>



					</uni-row>




					<view class="example-body">
						<uni-fav :checked="collect" :content-text="contentText" @click="favClick(collect)" />
					</view>
				</uni-card>
			</view>
			<view class="loading" v-if="showLoadMore">
				<image src="/static/loading.gif"></image>
			</view>
		



	</view>
	</scroll-view>
	<loading v-else></loading>
</template>
<script>
	import loading from '../../../components/loading/loading.vue'
	// TODO ä¿®å¤Android v3 åŠ è½½è¿‡æ…¢é—®é¢˜
	// #ifdef APP-PLUS
	var domModule = weex.requireModule('dom');
	domModule.addRule('fontFace', {
		'fontFamily': "uniicons",
		'src': "url('/static/uni.ttf')"
	});
	// #endif
	export default {
		components: {
			loading
		},
		props: {
			hasLeftWin: {
				type: Boolean
			},
			leftWinActive: {
				type: String
			},
			collect: {
				type: Boolean
			}
		},
		data() {
			return {
				contentText: {
					contentDefault: 'æ”¶è—',
					contentFav: 'å·²æ”¶è—'
				},
				loading: true,
				showLoadMore: false,
				list: [],
				indicatorDots: true,
				autoplay: true,
				interval: 2000,
				duration: 500,
				pricesChangeDay: 1,
				horizontal: 'right',
				vertical: 'top',
				direction: 'vertical',
				pattern: {
					color: '#7A7E83',
					backgroundColor: '#fff',
					selectedColor: '#007AFF',
					buttonColor: '#007AFF',
					iconColor: '#fff'
				},
				is_color_type: false,
				content: [{
						iconPath: '/static/shourt-lease.png',
						selectedIconPath: '/static/shourt-lease-sl.png',
						text: 'çŸ­ç§Ÿå¹´åŒ–',
						active: false
					},
					{
						iconPath: '/static/long-lease.png',
						selectedIconPath: '/static/long-lease-sl.png',
						text: 'é•¿ç§Ÿå¹´åŒ–',
						active: false
					},
					{
						iconPath: '/static/steam.png',
						selectedIconPath: '/static/steam-sl.png',
						text: 'æŒ‚åˆ€æ¯”ä¾‹',
						active: false
					},
					{
						iconPath: '/static/price-up.png',
						selectedIconPath: '/static/price-up-sl.png',
						text: 'æ¶¨ä»·æ’è¡Œ',
						active: false
					},
					{
						iconPath: '/static/price-up-precent.png',
						selectedIconPath: '/static/price-up-precent.png',
						text: 'æ¶¨ä»·ç™¾åˆ†æ¯”æ’è¡Œ',
						active: false
					},
					{
						iconPath: '/static/price-down.png',
						selectedIconPath: '/static/price-down-sl.png',
						text: 'è·Œä»·æ’è¡Œ',
						active: false
					},
					{
						iconPath: '/static/price-down-precnet.png',
						selectedIconPath: '/static/price-down-precent-sl.png',
						text: 'è·Œä»·ç™¾åˆ†æ¯”æ’è¡Œ',
						active: false
					}
				]
			}
		},
		onBackPress() {
			if (this.$refs.fab.isShow) {
				this.$refs.fab.close()
				return true
			}
			return false
		},
		onLoad() {
			this.initData();
		},
		onShareAppMessage() {
			return {
				title: 'æ¬¢è¿ä½“éªŒuni-app',
				path: '/pages/tabBar/component/component'
			}
		},
		onNavigationBarButtonTap(e) {
			uni.navigateTo({
				url: '/pages/about/about'
			});
		},
		onPullDownRefresh() {
			console.log('onPullDownRefresh');
			this.initData();
			// this.initData();
		},
		onReachBottom() {
			console.log("onReachBottom");
			// if (this.max > 40) {
			// 	this.loadMoreText = "æ²¡æœ‰æ›´å¤šæ•°æ®äº†!"
			// 	return;
			// }
			this.showLoadMore = true;
			setTimeout(() => {
				this.getMoreListData();
			}, 300);
		},
		// #ifdef H5
		watch: {
			$route: {
				immediate: true,
				handler(newRoute) {
					if (newRoute.matched.length) {
						let path = newRoute.path.split('/')[3]
						for (const item of this.list) {
							if (Array.isArray(item.pages)) {
								for (const page of item.pages) {
									if (page === path || page.url && page.url === newRoute.path) {
										item.open = true
									}
								}
							}
						}
					}
				}
			}
		},
		// #endif
		methods: {
			initData(){
				setTimeout(() => {
					uni.request({
						url: 'https://www.fastmock.site/mock/d52e60b6a14228ac1afac5b2899e2760/v1/shortLease', //ä»…ä¸ºç¤ºä¾‹ï¼Œå¹¶éçœŸå®æ¥å£åœ°å€ã€‚
						data: {
							text: 'uni.request'
						},
						header: {
							'custom-header': 'hello' //è‡ªå®šä¹‰è¯·æ±‚å¤´ä¿¡æ¯
						},
						success: (res) => {
							console.log(res.data);
							this.loading = false;
							this.list = res.data.rankList;
						}
					});
					uni.stopPullDownRefresh();
				}, 300);
			},
			getMoreListData() {
				uni.request({
					url: 'https://www.fastmock.site/mock/d52e60b6a14228ac1afac5b2899e2760/v1/shortLease', //ä»…ä¸ºç¤ºä¾‹ï¼Œå¹¶éçœŸå®æ¥å£åœ°å€ã€‚
					data: {
						text: 'uni.request'
					},
					header: {
						'custom-header': 'hello' //è‡ªå®šä¹‰è¯·æ±‚å¤´ä¿¡æ¯
					},
					success: (res) => {
						console.log(res.data);
						this.showLoadMore = false;
						let data = res.data.rankList;
						this.list = this.list.concat(data);
					}
				});
			},
			onrefresh(e) {
				console.log(1)
			},
			changeIndicatorDots(e) {
				this.indicatorDots = !this.indicatorDots
			},
			changeAutoplay(e) {
				this.autoplay = !this.autoplay
			},
			intervalChange(e) {
				this.interval = e.target.value
			},
			durationChange(e) {
				this.duration = e.target.value
			},
			trigger(e) {
				console.log(e)
				this.content[e.index].active = !e.item.active
				uni.showModal({
					title: 'æç¤º',
					content: `æ‚¨${this.content[e.index].active ? 'é€‰ä¸­äº†' : 'å–æ¶ˆäº†'}${e.item.text}`,
					success: function(res) {
						if (res.confirm) {
							console.log('ç”¨æˆ·ç‚¹å‡»ç¡®å®š')
						} else if (res.cancel) {
							console.log('ç”¨æˆ·ç‚¹å‡»å–æ¶ˆ')
						}
					}
				})
			},
			fabClick() {
				uni.showToast({
					title: 'ç‚¹å‡»äº†æ‚¬æµ®æŒ‰é’®',
					icon: 'none'
				})
			},
			favClick(index) {
				this.collect = !this.collect
				this.$forceUpdate()
			},
			priceFormat(price) {
				return price / 100.0;
			},
			getChangeTips(minPriceChangePercent) {
				var tips_str =
					`è¿‘1å¤©:${(minPriceChangePercent[1] *100).toFixed(2)}%\n è¿‘7å¤©:${(minPriceChangePercent[7] *100).toFixed(2)}% \nè¿‘15å¤©:${(minPriceChangePercent[15] *100).toFixed(2)} \nè¿‘30å¤©:${(minPriceChangePercent[30] *100).toFixed(2)}% \nè¿‘90å¤©:${(minPriceChangePercent[90] *100).toFixed(2)}%`
				return tips_str;
			},
			countShortLease(ShortLease, Price) {
				return (192 * ShortLease / Price * 100).toFixed(2);
			},
			countLongLease(LongLease, Price) {
				return (264 * LongLease / Price * 100).toFixed(2);
			},
			triggerCollapse(e, id) {
				if (!this.list[e].pages) {
					this.goDetailPage('', this.list[e].url);
					return;
				}
				for (var i = 0; i < this.list.length; ++i) {
					if (e === i) {
						this.list[i].open = !this.list[i].open;
					} else {
						this.list[i].open = false;
					}
				}
			},
			goDetailPage(panel, e) {
				if (typeof e === 'string') {
					const url = '/pages/component/' + e + '/' + e
					if (this.hasLeftWin) {
						uni.reLaunch({
							url: url
						})
					} else {
						uni.navigateTo({
							url: url
						})
					}
				} else {
					if (this.hasLeftWin) {
						uni.reLaunch({
							url: e.url
						})
					} else {
						uni.navigateTo({
							url: e.url
						})
					}
				}
			}
		}
	}
</script>

<style>
	@import '../../../common/uni-nvue.css';
</style>
